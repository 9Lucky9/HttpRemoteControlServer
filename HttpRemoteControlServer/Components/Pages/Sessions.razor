@page "/sessions"
@rendermode InteractiveServer

@using HttpRemoteControlServer.Contracts
@using HttpRemoteControlServer.Domain

@inject ILogger<Sessions> Logger;
@inject IClientSessionService ClientSessionService
@inject NavigationManager NavManager


<PageTitle>ActiveSessions</PageTitle>

<h1>ActiveSessions</h1>

<div class="view">
    @{
        if (ClientSessions == null)
        {
            <div>
                <h2>No sessions open right now. Waiting for session to open...</h2>
            </div>
        }
        if (ClientSessions != null)
        {
            foreach (var clientSession in ClientSessions)
            {
                <button class="session-button" type="button" 
                        @onclick="() => { OpenSession(clientSession.SessionId); }"
                        aria-label="Открыть сессию Ubuntu 24.04">
                    <div class="session-content">
                        <div class="session-info">
                            <div class="session-header">
                                <p class="session-name">@clientSession.RemoteClient.MachineInfo.HostName</p>
                                <p class="session-duration">@(DateTime.Today.ToUniversalTime() - clientSession.OpenedDateUtc)</p>
                            </div>
                            <p class="session-hostname">@clientSession.RemoteClient.MachineInfo.PrettyName</p>
                            <p class="session-ip">@clientSession.RemoteClient.MachineInfo.IpAddress</p>
                            <p class="session-sub">Нажмите, чтобы открыть</p>
                        </div>
                    </div>
                </button>
            }
        }
    }
</div>

@code {

    private List<RemoteClientSession>? ClientSessions { get; set; }

    
    protected async override Task OnInitializedAsync()
    {
        var clientSessions = 
            await ClientSessionService.GetClientSessions();
        ClientSessions = clientSessions.ToList();
        ClientSessionService.StateChanged += ClientSessionServiceOnStateChanged;
    }

    private async void ClientSessionServiceOnStateChanged(object? sender, EventArgs e)
    {
        try
        {
            var clientSessions = 
                await ClientSessionService.GetClientSessions();
            ClientSessions = clientSessions.ToList();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(
                "UI Layer. Sessions.razor has failed to async handle update from ClientSessionService. Ex: {ex}", ex);
        }
    }


    private void OpenSession(Guid sessionId)
    {
        NavManager.NavigateTo($"/session/{sessionId}", new NavigationOptions());
    }


    //private static List<ClientSession> TestClientSessions()
    //{
    //    return new List<ClientSession>()
    //    {
    //        new ClientSession()
    //        {
    //            SessionId = Guid.NewGuid(),
    //            Client = new Client()
    //            {
    //                Id = Guid.NewGuid(),
    //                MachineInfo = new MachineInfo()
    //                {
    //                    PrettyName = "Debian GNU/Linux 12 (bookworm)",
    //                    IpAddress = "172.20.17.130",
    //                    HostName = "k8s-controlplane01"
    //                }
    //            },
    //            OpenedDate = DateTime.UtcNow - TimeSpan.FromMinutes(5)
    //        },
    //        new ClientSession()
    //        {
    //            SessionId = Guid.NewGuid(),
    //            Client = new Client()
    //            {
    //                Id = Guid.NewGuid(),
    //                MachineInfo = new MachineInfo()
    //                {
    //                    
    //                }
    //            },
    //            OpenedDate = DateTime.UtcNow - TimeSpan.FromSeconds(30)
    //        }
    //    };
    //}

}